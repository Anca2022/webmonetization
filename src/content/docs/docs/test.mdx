---
title: Page for testing stuff
---

import { Tabs, TabItem } from '@astrojs/starlight/components'
import LinkOut from '/src/components/docs/LinkOut'
import CodeBlock from '/src/components/docs/CodeBlock'
import StylishHeader from '/src/components/docs/StylishHeader'

## Example flow

Alice web monetizes her site by adding the monetization `<link>` element to each page. The `<link>` element contains her payment pointer, `https://wallet.example/alice`.

Bob visits Alice's site and wants to send a Web Monetization payment. For this example, we assume:

- Bob has a relationship with a WM provider and the provider has supplied him with a sending account (`https://anotherwallet.example/bob`)
- Bob has installed a WM agent into his browser and linked the agent to his WM provider
- The WM agent has a grant to create outgoing payments on the sending account

<StylishHeader>Step 1 - Check for Web Monetization</StylishHeader>

As Bob browses Alice's site, his WM agent detects a well-formed monetization `<link>` element and fires a `load` event.

```html
<link rel="monetization" href="https://wallet.example/alice" />
```

<StylishHeader>Step 2 - Issue request to payment pointer</StylishHeader>

<Tabs>
	<TabItem label="Request">
        The WM agent issues a request to Alice's payment pointer URL to discover the Open Payments service endpoint.
        <CodeBlock title="Request">
        ```http
        GET /alice HTTP/1.1
        Accept: application/json
        Host: wallet.example
        ```
        </CodeBlock>
    </TabItem>
	<TabItem label="Response">
        The response includes details about Alice's underlying Open Payments-enabled account. Importantly, it contains the URL for her WM receiver's grant request endpoint (authorization server).
        <CodeBlock title="Response">
        ```http
        HTTP/1.1 200 Success
        Content-Type: application/json

        {
            "id":"https://wallet.example/alice",
            "assetCode":"USD",
            "assetScale":2,
            "authServer":"https://wallet.example/auth"
        }
        ```
        </CodeBlock>
    </TabItem>
</Tabs>

<StylishHeader>Step 3 - Send an incoming payment grant request</StylishHeader>

<Tabs>
	<TabItem label="Request">
        The WM agent issues a request to the WM receiver's grant request endpoint (authorization server) to get an access token.
        
        In this example, the WM agent requests access to create and read incoming payments (i.e., payments coming in to Alice's WM receiver).
        <CodeBlock title="Request">
        ```http
        POST /auth/ HTTP/1.1
        Accept: application/json
        Content-Type: application/json
        Host: wallet.example
        Content-Length: 218

        {
            "access_token": {
                "access":[
                    {
                        "type":"incoming-payment",
                        "actions":["create","read"],
                        "identifier":"https://wallet.example/alice"
                    }
                ]
            },
            "interact":
                {
                    "finish": {"method":"redirect"}
                },
            "client":"https://anotherwallet.example/bob"
        }
        ```
        </CodeBlock>
    </TabItem>
	<TabItem label="Response">
        The grant request is non-interactive, so the WM receiver grants the request and issues an access token.
        <CodeBlock title="Response">
        ```http
        {
            "access_token": {
                "value":"OS9M2PMHKUR64TB8N6BW7OZB8CDFONP219RP1LT0",
                "manage":"https://wallet.example/auth/token/dd17a202-9982-4ed9-ae31-564947fb6379"
                    "access": [
                        {
                            "type":"incoming-payment",
                            "actions":["create","read"],
                            "identifier":"https://wallet.example/alice"
                        }
                    ]
            },
        }
        ```
        </CodeBlock>
    </TabItem>
</Tabs>

<StylishHeader>Step 4 - Create an incoming payment request</StylishHeader>

<Tabs>
	<TabItem label="Request">
        The WM agent creates an incoming payment for the session (e.g., the open browser tab) by issuing an incoming payment request to the WM receiver. The request uses details obtained from the previous API calls.

        _Incoming_ payment is used here because the WM agent is requesting that the WM receiver allow an incoming payment to Alice's account. The payment itself has not been sent yet.
        <CodeBlock title="Request">
        ```http
        POST /alice/incoming-payments HTTP/1.1
        Accept: application/json
        Content-Type: application/json
        Authorization: OS9M2PMHKUR64TB8N6BW7OZB8CDFONP219RP1LT0
        Host: wallet.example
        ```
        </CodeBlock>
    </TabItem>
	<TabItem label="Response">
        The WM receiver approves the request by supplying unique payment details for the WM agent to use to address the payment to Alice's account.
        <CodeBlock title="Response">
        ```http
        {
            "id":"https://wallet.example/alice/incoming-payments/08394f02-7b7b-45e2-b645-51d04e7c330c",
            "paymentPointer":"https://wallet.example/alice",
            "receivedAmount": {
                "value":"0",
                "assetCode":"USD",
                "assetScale":2
            },
            "completed":false,
            "createdAt":"2022-03-12T23:20:50.52Z",
            "updatedAt":"2022-03-12T23:20:50.52Z",
        }
        ```
        </CodeBlock>
    </TabItem>
</Tabs>

<StylishHeader>Step 5 - Send a quote request</StylishHeader>

<Tabs>
	<TabItem label="Request">
        Up to this point, the WM agent has communicated with Alice's WM receiver. Now, the WM agent issues a request to Bob's WM provider to create a quote. The purpose of the quote is to tell the WM provider how much to send from Bob's account.

        In this example, the WM agent creates a quote to send $0.02 USD from Bob to Alice.

        Since we're assuming the WM agent already has a grant to create an outgoing payment on Bob's account, the grant access token will appear as the `Authorization` value in the header.
        <CodeBlock title="Request">
        ```http
        POST /bob/quote HTTP/1.1
        Accept: application/json
        Content-Type: application/json
        Authorization: {{ quoteGrant.accessToken.value }}
        Host: anotherwallet.example

        {
            "receiver": "https://wallet.example/alice/incoming-payments/08394f02-7b7b-45e2-b645-51d04e7c330c"
            "sendAmount": {
                "value":"2",
                "assetCode":"USD",
                "assetScale": 2
            }
        }
        ```
        </CodeBlock>
    </TabItem>
	<TabItem label="Response">
        The WM provider returns a quote with information about how much it will cost for the provider to pay into the incoming payment.
        <CodeBlock title="Response">
        ```http
        {
        "id": "https://anotherwallet.example/bob/quotes/8c68d3cc-0a0f-4216-98b4-4fa44a6c88cf",
        "paymentPointer": "https://anotherwallet.example/bob",
        "receiver": "https://wallet.example/alice/incoming-payments/08394f02-7b7b-45e2-b645-51d04e7c330c"
        "sendAmount": {
            "value": "2",
            "assetCode": "USD",
            "assetScale": 2
        },
        "receiveAmount": {
            "value": "2",
            "assetCode": "USD",
            "assetScale": 2
        },
        "createdAt": "2022-03-12T23:20:50.52Z",
        "expiresAt": "2022-04-12T23:20:50.52Z"
        }
        ```
        </CodeBlock>
    </TabItem>
</Tabs>

<StylishHeader>Step 6 - Send outgoing payment request</StylishHeader>

<Tabs>
	<TabItem label="Request">
        The WM agent uses the details obtained thus far to create an outgoing payment request against Bob's payment pointer. Note that this is just a request to send a payment. The payment itself has not been sent yet.
        <CodeBlock title="Request">
        ```http
        POST /bob/outgoing-payment HTTP/1.1
        Accept: application/json
        Content-Type: application/json
        Authorization: {{ outgoingPaymentGrant.accessToken.value }}
        Host: anotherwallet.example
        Content-Length: 89

        {
            "quoteId":
        "https://anotherwallet.example/bob/quotes/8c68d3cc-0a0f-4216-98b4-4fa44a6c88cf"
        }
        ```
        </CodeBlock>
    </TabItem>
	<TabItem label="Response">
        <CodeBlock title="Response">
        ```http
        {
            "id":"https://anotherwallet.example/bob/outgoing-payments/8c68d3cc-0a0f-
                4216-98b4-4fa44a6c88cf",
            "paymentPointer":"https://anotherwallet.example/bob/",
            "receiver":"https://wallet.example/alice/incoming-payments/08394f02-7b7b-
                        45e2-b645-51d04e7c330c
            "receiveAmount": {
                "value":"2",
                "assetCode":"USD",
                "assetScale":2
            },
            "sendAmount": {
                "value":"2",
                "assetCode":"USD",
                "assetScale":2
            },
            "sentAmount": {
                "value":"0",
                "assetCode":"USD",
                "assetScale":2
            },
            "createdAt":"2022-03-12T23:20:55.52Z",
            "updatedAt":"2022-03-12T23:20:55.52Z"
        }
        ```
        </CodeBlock>
    </TabItem>
</Tabs>

The Web Monetization flow is complete. Now the WM provider can create a payment session with the WM receiver to process and settle the payment.